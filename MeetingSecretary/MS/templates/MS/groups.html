{% extends 'MS/base.html' %}
{% load i18n staticfiles %}

{% block title %}Groups{% endblock %}
{% block extra_head %}
<script src="http://ajax.aspnetcdn.com/ajax/jquery/jquery-3.2.0.min.js"></script>
{% endblock %}

{% block content %}
<h2></h2>
<h4>Administrator: </h4>
<p>Members: </p>
<ol>
</ol>
Add a new member: <form id = "addnewmember" method = "POST">
	{% csrf_token %}
<input type="text" id = "newmembername">
<input type="submit" value = "send invitation">
</form>
<form id = "deletemember" method = "POST">
	{% csrf_token %}
<input type="text" id = "deletename">
<input type="submit" value = "delete a member">
</form>   
<form  id ="searchtime">
	<div class="form-row align-items-center">
	  <div class="col-auto">
		<label class="mr-sm-2" for="inlineFormInputStartTime">Start Time: </label>
		<input type="text" class="form-control" id="inlineFormInputStartTime" value = "2017-11-25" required>
	  </div>
	  <div class="col-auto">
		<label class="mr-sm-2" for="inlineFormInputEndTime">End Time: </label>
		<div class="input-group mb-2 mb-sm-0">
		  <input type="text" class="form-control" id="inlineFormInputEndTime" value = "2017-11-26" required>
		</div>
	  </div>
	  <div class="col-auto">
		<button type="submit" class="btn btn-primary">Search available time slots</button>
	  </div>
	</div>
  </form>

  <ul class="list-group" id="time-slots-list">
	<li class="list-group-item">Cras justo odio</li>

  </ul>
<script>
$(document).ready(function(){
		var url = window.location.href;
		var index = url.indexOf("groups") + 7;
		var group_name = url.substring(index);
		$("h2").append("<h2>" + group_name + "</h2>");
		$.ajax({
			type: 'POST',
			url: '/ajax/showgroup/',
			data: {group_name, csrfmiddlewaretoken:'{{ csrf_token}}'},
			dataType: 'json',
			success: function(data){
				$("h4").append(data['admin']);
				var count = data['member'].length;
				for (var i = 0; i < count; ++i)
					$("ol").append("<li>" + data['member'][i]+ "</li>");
					//"<button type='button'" + "onclick = deletemember('" + data[i] + "')" 
					//+ "value = " + "'"+ data[i] + "'"
					//+ "id = " + "'member"+ data[i] + "'"
					//+">delete</button>"+"</li>");

			}
		});
	});


</script>

<script>
		$("#addnewmember").submit(function(event){
			event.preventDefault();
			var url = window.location.href;
			var index = url.indexOf("groups") + 7;
			var group_name = url.substring(index);
			var memberid = document.getElementById('newmembername').value;
			//var messages = document.getElementById('messages').value;
			var group_admin = '{{ user.username }}'
			$.ajax({
				type: "POST",
				url: "/ajax/addnewmember/",
				data: {group_name, group_admin, memberid, csrfmiddlewaretoken: '{{ csrf_token }}'},
				dataType:'json',
				success:function(data){
					if(data['valid'] == 'true')
						alert("Your invitation is on the way!");
					else
						alert("Send failed.:(")
				}
			});
		});

		$("#deletemember").submit(function(event){
			event.preventDefault();
			var memberid = document.getElementById('deletename').value;
			var operationuser = '{{ user.username }}'
			var url = window.location.href;
			var index = url.indexOf("groups") + 7;
			var group_name = url.substring(index);
			$.ajax({
				type: "POST",
				url: "/ajax/deletemember/",
				data: {memberid,group_name,operationuser,csrfmiddlewaretoken: '{{ csrf_token }}'},
				dataType:'json',
				success:function(data){
					if(data['valid'] == 'true')
						alert("User "+ memberid + " has been removed from group " + group_name + "! Please refresh the page to see your group.");
					else
						alert("You have no authorization to delete people to this group.")
				}
			});
		});


		$("#searchtime").submit(function(event){
			event.preventDefault();
			var start_time = document.getElementById("inlineFormInputStartTime").value;
			var end_time = document.getElementById("inlineFormInputEndTime").value;
			var url = window.location.href;
			var index = url.indexOf("groups") + 7;
			var group_name = url.substring(index);
			$.ajax({
				type: "POST",
				url: "/ajax/searchtime/",
				data: {start_time, end_time, group_name, csrfmiddlewaretoken: '{{ csrf_token }}'},
				dataType: 'json',
				success: function(data) {
					alert("success");
					var slot_count = data['slots'].length;
					alert(slot_count);
					for (var i = 0; i < slot_count; ++i) {
						var start = data['slots'][i][0];
						var end = data['slots'][i][1];
						//add time converter;
						$("#time-slots-list").append("<li class = 'list-group-item list-group-item-action'>"+ start + "-" + end +"</li>");
					}
				}
			});
		});
</script>
{% endblock %}

{% block footer%}
{% endblock %}